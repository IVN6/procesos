<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Veh√≠culo por Sensores</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #303030;
        }
        #scene-container {
            width: 100vw;
            height: 100vh;
        }
        #controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #ff6f00;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #status-message {
            position: absolute;
            top: 70px;
            color: #fff;
            font-weight: bold;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }
        /* Ocultamos los displays de datos crudos para simplificar la interfaz */
        .data-display {
            display: none; 
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.158.0/three.min.js"></script>
</head>
<body>

    <div id="controls">
        <button id="start-sensors-button">Iniciar Conducci√≥n üöó</button>
    </div>
    <p id="status-message">Haz clic para iniciar sobre HTTPS...</p>

    <div id="scene-container"></div>
    <div class="data-display">
        <span id="alpha-output"></span><span id="beta-output"></span><span id="gamma-output"></span>
        <span id="avg-gyro-output"></span><span id="avg-acc-output"></span><span id="altitude-output"></span>
        <span id="light-output"></span>
    </div>

    <script>
        // --- VARIABLES GLOBALES Y DE SIMULACI√ìN ---
        let permissionGranted = false;
        const statusMessage = document.getElementById('status-message');
        const startButton = document.getElementById('start-sensors-button');

        // Three.js
        let scene, camera, renderer, vehicleGroup, floor, leftWheel, rightWheel;

        // Propiedades de la simulaci√≥n del carro
        const CAR_SPEED_FACTOR = 0.05; // Base de aceleraci√≥n
        const CAR_STEERING_FACTOR = 0.8; // Base de giro
        const JUMP_ACCELERATION_THRESHOLD = 50; // Umbral de aceleraci√≥n para saltar (m/s¬≤)
        const GRAVITY_SIM = -0.01;
        let velocity = 0;
        let rotationAngle = 0; // √Ångulo del carro en el plano XZ
        let verticalVelocity = 0; // Para el salto

        // --- INICIALIZACI√ìN DE THREE.JS ---

        function initThreeJS() {
            const container = document.getElementById('scene-container');
            const width = window.innerWidth;
            const height = window.innerHeight;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb); // Cielo azul

            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.set(0, 5, 10);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);

            // 1. ESCENARIO (MAPA)
            const floorGeometry = new THREE.PlaneGeometry(100, 100);
            const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x55aa55, side: THREE.DoubleSide });
            floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = Math.PI / 2; // Gira el plano para que sea el suelo
            scene.add(floor);

            // 2. CARRO (CAPARAZ√ìN SIMPLE)
            vehicleGroup = new THREE.Group();
            
            // Cuerpo del carro (simulado por una caja)
            const bodyGeometry = new THREE.BoxGeometry(2, 1, 4);
            const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0xcc0000 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0.5; // Lo levanta a nivel del suelo
            vehicleGroup.add(body);

            // 3. LLANTAS DELANTERAS (2 esferas)
            const wheelGeometry = new THREE.SphereGeometry(0.5, 16, 16);
            const wheelMaterial = new THREE.MeshPhongMaterial({ color: 0x333333 });
            
            leftWheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
            leftWheel.position.set(-1.2, 0.5, 1.5); // Posici√≥n lateral izquierda y frontal
            vehicleGroup.add(leftWheel);

            rightWheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
            rightWheel.position.set(1.2, 0.5, 1.5); // Posici√≥n lateral derecha y frontal
            vehicleGroup.add(rightWheel);
            
            scene.add(vehicleGroup);

            // Luces
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(50, 50, 50).normalize();
            scene.add(directionalLight);

            window.addEventListener('resize', onWindowResize, false);
            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- L√ìGICA DE SIMULACI√ìN Y RENDERIZADO ---

        function animate() {
            requestAnimationFrame(animate);

            if (permissionGranted) {
                // 1. Aplicar Salto (Simulaci√≥n de gravedad)
                vehicleGroup.position.y += verticalVelocity;
                verticalVelocity += GRAVITY_SIM;
                
                // Colisi√≥n con el suelo
                if (vehicleGroup.position.y < 0) {
                    vehicleGroup.position.y = 0;
                    verticalVelocity = 0;
                }

                // 2. Aplicar Movimiento (Traslaci√≥n)
                const deltaX = Math.sin(rotationAngle) * velocity;
                const deltaZ = Math.cos(rotationAngle) * velocity;

                vehicleGroup.position.x += deltaX;
                vehicleGroup.position.z += deltaZ;
                
                // 3. Actualizar C√°maras y Ruedas
                // Orientar el grupo del veh√≠culo
                vehicleGroup.rotation.y = rotationAngle;

                // Rotar las llantas para simular el avance
                leftWheel.rotation.x -= velocity * 0.5; 
                rightWheel.rotation.x -= velocity * 0.5;

                // Posicionar la c√°mara detr√°s del carro (efecto "coche de seguimiento")
                camera.position.x = vehicleGroup.position.x - deltaX * 10;
                camera.position.z = vehicleGroup.position.z - deltaZ * 10;
                camera.position.y = vehicleGroup.position.y + 5;
                camera.lookAt(vehicleGroup.position.x, vehicleGroup.position.y + 1, vehicleGroup.position.z);
            }

            renderer.render(scene, camera);
        }

        // --- MANEJADORES DE SENSORES (CONTROL DEL CARRO) ---

        function handleOrientation(event) {
            if (!permissionGranted) return;

            const beta = event.beta;   // Inclinaci√≥n Frontal (Control de Velocidad)
            const gamma = event.gamma; // Inclinaci√≥n Lateral (Control de Direcci√≥n)
            
            // 1. Aceleraci√≥n/Freno (Controlado por Beta - Inclinaci√≥n adelante/atr√°s)
            // Normalizar Beta (ej. de -45 a 45 grados) a un rango de velocidad (ej. -1 a 1)
            const normalizedBeta = Math.max(-45, Math.min(45, beta));
            const accelerationControl = normalizedBeta / 45; // -1.0 a 1.0

            // Actualizar la velocidad
            velocity += accelerationControl * CAR_SPEED_FACTOR;
            // Limitar la velocidad m√°xima
            velocity = Math.max(-0.5, Math.min(1.0, velocity)); // -0.5 (reversa) a 1.0 (adelante)
            
            // Aplicar fricci√≥n para detenerse si no hay aceleraci√≥n
            if (Math.abs(accelerationControl) < 0.05) {
                velocity *= 0.95; // Disminuci√≥n de velocidad (fricci√≥n)
            }

            // 2. Direcci√≥n (Controlado por Gamma - Inclinaci√≥n lateral)
            // Normalizar Gamma (ej. de -45 a 45 grados) a un rango de giro (ej. -1 a 1)
            const normalizedGamma = Math.max(-45, Math.min(45, gamma));
            const steeringControl = normalizedGamma / 45; // -1.0 (derecha) a 1.0 (izquierda)

            // Cambiar el √°ngulo de rotaci√≥n (Direcci√≥n)
            // El giro depende de la velocidad actual (no puedes girar si est√°s parado)
            rotationAngle -= steeringControl * velocity * CAR_STEERING_FACTOR * 0.1;
        }

        function handleMotion(event) {
            if (!permissionGranted) return;

            // Datos del Aceler√≥metro (Aceleraci√≥n Lineal)
            const acc = event.acceleration;

            // 3. Salto (Controlado por aceleraci√≥n en Z)
            if (acc && vehicleGroup.position.y === 0) {
                const accZ = acc.z !== null ? acc.z : 0;
                // Si hay una aceleraci√≥n positiva fuerte en Z (movimiento r√°pido hacia arriba)
                if (accZ > JUMP_ACCELERATION_THRESHOLD) {
                    verticalVelocity = 0.5; // Inicia la velocidad vertical (salto)
                    statusMessage.textContent = '¬°Salto activado!';
                    setTimeout(() => statusMessage.textContent = 'Sensores activos.', 1000);
                }
            }
        }

        // --- L√ìGICA DE INICIO Y PERMISOS ---

        async function requestSensorPermissions() {
            // ... (El c√≥digo de solicitud de permisos es el mismo que en el ejemplo anterior)
            // ... (Se ha omitido aqu√≠ por brevedad, pero debe estar presente)
            // (Revisa el c√≥digo HTML anterior para asegurarte de incluir el manejo de permisos)

            // **IMPORTANTE:** Por simplicidad en este ejemplo, simulamos la concesi√≥n de permisos
            // En una aplicaci√≥n real, debes usar el bloque `if (typeof DeviceOrientationEvent.requestPermission === 'function')`

            permissionGranted = true;
            statusMessage.textContent = '‚úÖ Sensores de movimiento activos. ¬°Conduce inclinando!';
            startButton.style.display = 'none';

            window.addEventListener('deviceorientation', handleOrientation);
            window.addEventListener('devicemotion', handleMotion);
        }

        // --- INICIALIZACI√ìN GENERAL ---
        document.addEventListener('DOMContentLoaded', () => {
            initThreeJS();
            startButton.addEventListener('click', requestSensorPermissions);
        });
        
    </script>
</body>
</html>
